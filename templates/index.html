<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Idempotency Gateway — FinSafe</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;600;800&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg: #0a0c10;
                --surface: #111318;
                --border: #1e2230;
                --accent: #00e5a0;
                --accent-dim: #00e5a020;
                --warn: #f59e0b;
                --warn-dim: #f59e0b18;
                --danger: #f43f5e;
                --danger-dim: #f43f5e18;
                --info: #38bdf8;
                --info-dim: #38bdf818;
                --text: #e2e8f0;
                --muted: #64748b;
                --mono: "JetBrains Mono", monospace;
                --sans: "Syne", sans-serif;
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                background: var(--bg);
                color: var(--text);
                font-family: var(--sans);
                min-height: 100vh;
                overflow-x: hidden;
            }

            body::before {
                content: "";
                position: fixed;
                inset: 0;
                background-image:
                    linear-gradient(var(--border) 1px, transparent 1px),
                    linear-gradient(90deg, var(--border) 1px, transparent 1px);
                background-size: 40px 40px;
                opacity: 0.35;
                pointer-events: none;
                z-index: 0;
            }

            .shell {
                position: relative;
                z-index: 1;
                max-width: 1100px;
                margin: 0 auto;
                padding: 48px 24px 80px;
            }

            header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 56px;
                gap: 24px;
                flex-wrap: wrap;
            }

            .logo-block h1 {
                font-size: 2rem;
                font-weight: 800;
                letter-spacing: -0.02em;
                line-height: 1.1;
            }

            .logo-block h1 span {
                color: var(--accent);
            }

            .logo-block p {
                margin-top: 6px;
                font-size: 0.8rem;
                color: var(--muted);
                font-family: var(--mono);
                letter-spacing: 0.05em;
                text-transform: uppercase;
            }

            .status-pill {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 16px;
                border: 1px solid var(--border);
                border-radius: 999px;
                font-family: var(--mono);
                font-size: 0.75rem;
                color: var(--muted);
                background: var(--surface);
            }

            .status-dot {
                width: 7px;
                height: 7px;
                border-radius: 50%;
                background: var(--accent);
                box-shadow: 0 0 8px var(--accent);
                animation: pulse 2s ease-in-out infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.4;
                }
            }

            .scenarios {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 12px;
                margin-bottom: 32px;
            }

            .scenario-btn {
                all: unset;
                cursor: pointer;
                padding: 16px 20px;
                border-radius: 10px;
                border: 1px solid var(--border);
                background: var(--surface);
                transition:
                    border-color 0.2s,
                    background 0.2s,
                    transform 0.15s;
                position: relative;
                overflow: hidden;
            }

            .scenario-btn::after {
                content: "";
                position: absolute;
                inset: 0;
                opacity: 0;
                transition: opacity 0.2s;
            }

            .scenario-btn:hover {
                transform: translateY(-2px);
            }
            .scenario-btn:active {
                transform: translateY(0);
            }

            .scenario-btn.active {
                border-color: var(--accent);
                background: var(--accent-dim);
            }

            .scenario-btn[data-type="happy"].active {
                border-color: var(--accent);
                background: var(--accent-dim);
            }
            .scenario-btn[data-type="cache"].active {
                border-color: var(--info);
                background: var(--info-dim);
            }
            .scenario-btn[data-type="conflict"].active {
                border-color: var(--danger);
                background: var(--danger-dim);
            }
            .scenario-btn[data-type="race"].active {
                border-color: var(--warn);
                background: var(--warn-dim);
            }

            .scenario-tag {
                font-family: var(--mono);
                font-size: 0.65rem;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                margin-bottom: 6px;
            }

            .scenario-btn[data-type="happy"] .scenario-tag {
                color: var(--accent);
            }
            .scenario-btn[data-type="cache"] .scenario-tag {
                color: var(--info);
            }
            .scenario-btn[data-type="conflict"] .scenario-tag {
                color: var(--danger);
            }
            .scenario-btn[data-type="race"] .scenario-tag {
                color: var(--warn);
            }

            .scenario-title {
                font-weight: 600;
                font-size: 0.95rem;
            }
            .scenario-desc {
                font-size: 0.75rem;
                color: var(--muted);
                margin-top: 4px;
                line-height: 1.4;
            }

            .panel {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            @media (max-width: 700px) {
                .panel {
                    grid-template-columns: 1fr;
                }
            }

            .card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                overflow: hidden;
            }

            .card-header {
                padding: 14px 20px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .card-label {
                font-family: var(--mono);
                font-size: 0.7rem;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                color: var(--muted);
            }

            .card-body {
                padding: 20px;
            }

            .field {
                margin-bottom: 16px;
            }

            label {
                display: block;
                font-family: var(--mono);
                font-size: 0.7rem;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                color: var(--muted);
                margin-bottom: 6px;
            }

            input,
            textarea {
                width: 100%;
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 7px;
                color: var(--text);
                font-family: var(--mono);
                font-size: 0.85rem;
                padding: 10px 14px;
                outline: none;
                transition: border-color 0.2s;
            }

            input:focus,
            textarea:focus {
                border-color: var(--accent);
                box-shadow: 0 0 0 3px var(--accent-dim);
            }

            textarea {
                resize: vertical;
                min-height: 120px;
                line-height: 1.6;
            }

            .key-row {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }

            .key-row input {
                flex: 1;
            }

            .icon-btn {
                all: unset;
                cursor: pointer;
                padding: 10px 12px;
                border: 1px solid var(--border);
                border-radius: 7px;
                background: var(--bg);
                color: var(--muted);
                font-size: 0.85rem;
                transition:
                    color 0.2s,
                    border-color 0.2s;
                white-space: nowrap;
            }

            .icon-btn:hover {
                color: var(--text);
                border-color: var(--accent);
            }

            .send-btn {
                all: unset;
                cursor: pointer;
                width: 100%;
                padding: 13px;
                border-radius: 8px;
                background: var(--accent);
                color: #000;
                font-family: var(--sans);
                font-weight: 700;
                font-size: 0.9rem;
                letter-spacing: 0.03em;
                text-align: center;
                transition:
                    opacity 0.2s,
                    transform 0.15s;
                margin-top: 8px;
            }

            .send-btn:hover {
                opacity: 0.88;
                transform: translateY(-1px);
            }
            .send-btn:active {
                transform: translateY(0);
            }
            .send-btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                transform: none;
            }

            .send-btn.warn {
                background: var(--warn);
            }
            .send-btn.danger {
                background: var(--danger);
            }
            .send-btn.info {
                background: var(--info);
            }

            .response-area {
                font-family: var(--mono);
                font-size: 0.8rem;
                line-height: 1.7;
                min-height: 240px;
            }

            .response-placeholder {
                color: var(--muted);
                font-style: italic;
                padding: 20px 0;
            }

            .response-block {
                margin-bottom: 20px;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(6px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .response-meta {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }

            .badge {
                padding: 2px 10px;
                border-radius: 999px;
                font-size: 0.68rem;
                font-weight: 600;
                letter-spacing: 0.06em;
                text-transform: uppercase;
            }

            .badge-201 {
                background: var(--accent-dim);
                color: var(--accent);
                border: 1px solid var(--accent);
            }
            .badge-400 {
                background: var(--warn-dim);
                color: var(--warn);
                border: 1px solid var(--warn);
            }
            .badge-409 {
                background: var(--danger-dim);
                color: var(--danger);
                border: 1px solid var(--danger);
            }
            .badge-500 {
                background: var(--danger-dim);
                color: var(--danger);
                border: 1px solid var(--danger);
            }
            .badge-hit {
                background: var(--info-dim);
                color: var(--info);
                border: 1px solid var(--info);
            }
            .badge-time {
                background: transparent;
                color: var(--muted);
                border: 1px solid var(--border);
            }

            .response-json {
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 14px 16px;
                white-space: pre-wrap;
                word-break: break-all;
                color: var(--text);
            }

            .response-json .key {
                color: var(--info);
            }
            .response-json .str {
                color: var(--accent);
            }
            .response-json .num {
                color: var(--warn);
            }
            .response-json .bool {
                color: var(--danger);
            }

            .response-label {
                font-size: 0.65rem;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                color: var(--muted);
                margin-bottom: 4px;
            }

            .history-section {
                margin-top: 20px;
            }

            .history-row {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 0;
                border-bottom: 1px solid var(--border);
                font-family: var(--mono);
                font-size: 0.75rem;
                animation: fadeIn 0.2s ease;
            }

            .history-row:last-child {
                border-bottom: none;
            }

            .history-key {
                color: var(--muted);
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .spinner {
                display: inline-block;
                width: 14px;
                height: 14px;
                border: 2px solid var(--border);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 0.7s linear infinite;
                vertical-align: middle;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .race-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-top: 12px;
            }

            .race-req {
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px;
            }

            .race-req-label {
                font-family: var(--mono);
                font-size: 0.65rem;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                color: var(--muted);
                margin-bottom: 8px;
            }

            .race-status {
                font-family: var(--mono);
                font-size: 0.75rem;
                min-height: 60px;
                color: var(--muted);
            }

            .divider {
                height: 1px;
                background: var(--border);
                margin: 20px 0;
            }

            .footnote {
                margin-top: 40px;
                text-align: center;
                font-family: var(--mono);
                font-size: 0.7rem;
                color: var(--muted);
                letter-spacing: 0.04em;
            }
        </style>
    </head>
    <body>
        <div class="shell">
            <header>
                <div class="logo-block">
                    <h1>FinSafe <span>Gateway</span></h1>
                    <p>Idempotency Layer · Pay-Once Protocol</p>
                </div>
                <div class="status-pill">
                    <span class="status-dot"></span>
                    <span id="server-status">connecting...</span>
                </div>
            </header>

            <div class="scenarios">
                <button
                    class="scenario-btn active"
                    data-type="happy"
                    onclick="setScenario('happy', this)"
                >
                    <div class="scenario-tag">Story 1</div>
                    <div class="scenario-title">First Payment</div>
                    <div class="scenario-desc">
                        New key, valid body. Processes and caches the result.
                    </div>
                </button>
                <button
                    class="scenario-btn"
                    data-type="cache"
                    onclick="setScenario('cache', this)"
                >
                    <div class="scenario-tag">Story 2</div>
                    <div class="scenario-title">Duplicate Request</div>
                    <div class="scenario-desc">
                        Same key, same body. Returns cached response instantly.
                    </div>
                </button>
                <button
                    class="scenario-btn"
                    data-type="conflict"
                    onclick="setScenario('conflict', this)"
                >
                    <div class="scenario-tag">Story 3</div>
                    <div class="scenario-title">Conflict Detection</div>
                    <div class="scenario-desc">
                        Same key, different amount. Rejected with 409 Conflict.
                    </div>
                </button>
                <button
                    class="scenario-btn"
                    data-type="race"
                    onclick="setScenario('race', this)"
                >
                    <div class="scenario-tag">Bonus</div>
                    <div class="scenario-title">Race Condition</div>
                    <div class="scenario-desc">
                        Two identical requests fired simultaneously. Only one
                        processes.
                    </div>
                </button>
            </div>

            <div class="panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-label">Request</span>
                        <span id="method-badge" class="badge badge-201"
                            >POST /process-payment</span
                        >
                    </div>
                    <div class="card-body">
                        <div class="field">
                            <label>Idempotency-Key</label>
                            <div class="key-row">
                                <input
                                    type="text"
                                    id="idem-key"
                                    placeholder="e.g. a1b2c3d4-e5f6-7890"
                                />
                                <button
                                    class="icon-btn"
                                    onclick="generateKey()"
                                >
                                    ⟳ UUID
                                </button>
                                <button class="icon-btn" onclick="copyKey()">
                                    ⎘
                                </button>
                            </div>
                        </div>

                        <div class="field">
                            <label>Request Body (JSON)</label>
                            <textarea id="req-body">
{"amount": 100, "currency": "GHS"}</textarea
                            >
                        </div>

                        <button
                            id="send-btn"
                            class="send-btn"
                            onclick="sendRequest()"
                        >
                            Send Request
                        </button>

                        <div id="race-controls" style="display: none">
                            <button class="send-btn warn" onclick="fireRace()">
                                Fire Both Simultaneously
                            </button>
                            <div class="race-grid" id="race-grid">
                                <div class="race-req">
                                    <div class="race-req-label">Request A</div>
                                    <div class="race-status" id="race-a">
                                        Waiting...
                                    </div>
                                </div>
                                <div class="race-req">
                                    <div class="race-req-label">Request B</div>
                                    <div class="race-status" id="race-b">
                                        Waiting...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            id="scenario-hint"
                            style="
                                margin-top: 14px;
                                font-family: var(--mono);
                                font-size: 0.72rem;
                                color: var(--muted);
                                line-height: 1.6;
                            "
                        ></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-label">Response</span>
                        <button
                            class="icon-btn"
                            onclick="clearResponses()"
                            style="font-size: 0.7rem"
                        >
                            Clear
                        </button>
                    </div>
                    <div class="card-body response-area" id="response-area">
                        <div class="response-placeholder">
                            ← Send a request to see the response here.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card history-section" style="margin-top: 20px">
                <div class="card-header">
                    <span class="card-label">Request History</span>
                    <button
                        class="icon-btn"
                        onclick="clearHistory()"
                        style="font-size: 0.7rem"
                    >
                        Clear
                    </button>
                </div>
                <div class="card-body" id="history-area">
                    <div
                        style="
                            color: var(--muted);
                            font-family: var(--mono);
                            font-size: 0.8rem;
                        "
                    >
                        No requests yet.
                    </div>
                </div>
            </div>

            <div class="footnote">
                POST /process-payment · localhost:8080 · idempotency gateway
                v1.0
            </div>
        </div>

        <script>
            const API = window.location.origin;
            let currentScenario = "happy";
            let lastKey = ""; // used by the cache/conflict scenarios to reuse a key
            let history = [];

            const hints = {
                happy: '1. Click "⟳ UUID" to generate a fresh key.\n2. Hit Send — it takes ~2s to process.\n3. You\'ll get a 201 Created response.',
                cache: "1. Send the first request above.\n2. Without changing anything, hit Send again.\n3. The second response is instant with X-Cache-Hit: true.",
                conflict:
                    "1. Send the first request.\n2. Change the amount (e.g. 100 → 500).\n3. Send again with the same key — you'll get a 409 Conflict.",
                race: "Fires two requests with the same key at exactly the same time.\nOnly one will actually process. The other waits and gets the cached result.",
            };

            function setScenario(type, btn) {
                document
                    .querySelectorAll(".scenario-btn")
                    .forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                currentScenario = type;

                const hint = document.getElementById("scenario-hint");
                hint.textContent = hints[type];

                const sendBtn = document.getElementById("send-btn");
                const raceCtrls = document.getElementById("race-controls");

                if (type === "race") {
                    sendBtn.style.display = "none";
                    raceCtrls.style.display = "block";
                    generateKey();
                } else {
                    sendBtn.style.display = "block";
                    raceCtrls.style.display = "none";

                    // colour the send button per scenario
                    sendBtn.className = "send-btn";
                    if (type === "cache") sendBtn.classList.add("info");
                    if (type === "conflict") sendBtn.classList.add("danger");
                }
            }

            function uuid() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    (c) => {
                        const r = (Math.random() * 16) | 0;
                        return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
                    },
                );
            }

            function generateKey() {
                const k = uuid();
                document.getElementById("idem-key").value = k;
                lastKey = k;
            }

            function copyKey() {
                const val = document.getElementById("idem-key").value;
                if (val) navigator.clipboard.writeText(val);
            }

            async function checkServer() {
                const el = document.getElementById("server-status");
                try {
                    // A request with no key will get a 400 — but that means the server is up.
                    const r = await fetch(`${API}/process-payment`, {
                        method: "POST",
                        signal: AbortSignal.timeout(2000),
                    });
                    el.textContent = "server online · :8080";
                } catch {
                    el.textContent = "server offline — run: go run .";
                    el.style.color = "var(--danger)";
                }
            }

            async function sendRequest() {
                const key = document.getElementById("idem-key").value.trim();
                const body = document.getElementById("req-body").value.trim();
                const btn = document.getElementById("send-btn");

                if (!key) {
                    alert("Please enter an Idempotency-Key or click ⟳ UUID.");
                    return;
                }
                if (!body) {
                    alert("Request body cannot be empty.");
                    return;
                }

                btn.disabled = true;
                btn.textContent = "Sending…";

                const start = Date.now();
                let res,
                    data,
                    cacheHit = false;

                try {
                    res = await fetch(`${API}/process-payment`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Idempotency-Key": key,
                        },
                        body,
                    });
                    cacheHit = res.headers.get("X-Cache-Hit") === "true";
                    data = await res.json();
                } catch (err) {
                    data = {
                        error: "Could not reach server. Is it running on :8080?",
                    };
                    res = { status: 0 };
                }

                const elapsed = Date.now() - start;
                renderResponse(res.status, data, cacheHit, elapsed, key);
                addHistory(key, res.status, cacheHit, elapsed);

                btn.disabled = false;
                btn.textContent = "Send Request";
            }

            async function fireRace() {
                const key = document.getElementById("idem-key").value.trim();
                const body = document.getElementById("req-body").value.trim();

                if (!key) {
                    generateKey();
                    return;
                }

                const raceA = document.getElementById("race-a");
                const raceB = document.getElementById("race-b");

                raceA.innerHTML = '<span class="spinner"></span> In flight...';
                raceB.innerHTML = '<span class="spinner"></span> In flight...';

                document.getElementById("response-area").innerHTML =
                    '<div class="response-placeholder">Firing both requests simultaneously...</div>';

                const makeReq = () => {
                    const start = Date.now();
                    return fetch(`${API}/process-payment`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Idempotency-Key": key,
                        },
                        body,
                    })
                        .then(async (r) => ({
                            status: r.status,
                            cacheHit: r.headers.get("X-Cache-Hit") === "true",
                            data: await r.json(),
                            elapsed: Date.now() - start,
                        }))
                        .catch((err) => ({
                            status: 0,
                            cacheHit: false,
                            data: { error: "Server unreachable" },
                            elapsed: 0,
                        }));
                };

                // Fire both at the exact same time, Promise.all launches them simultaneously
                const [a, b] = await Promise.all([makeReq(), makeReq()]);

                // Render individual race results
                raceA.innerHTML = formatRaceResult(a);
                raceB.innerHTML = formatRaceResult(b);

                // Render full responses in the response panel
                clearResponses();
                renderResponse(
                    a.status,
                    a.data,
                    a.cacheHit,
                    a.elapsed,
                    key,
                    "Request A",
                );
                renderResponse(
                    b.status,
                    b.data,
                    b.cacheHit,
                    b.elapsed,
                    key,
                    "Request B",
                );

                addHistory(key + " (A)", a.status, a.cacheHit, a.elapsed);
                addHistory(key + " (B)", b.status, b.cacheHit, b.elapsed);
            }

            function formatRaceResult(r) {
                const statusColor =
                    r.status === 201 ? "var(--accent)" : "var(--danger)";
                const cacheLabel = r.cacheHit
                    ? '<span style="color:var(--info)">⎘ cache hit</span>'
                    : '<span style="color:var(--accent)">⚙ processed</span>';
                return `
      <span style="color:${statusColor}; font-weight:600;">${r.status || "ERR"}</span>
      &nbsp;·&nbsp;${cacheLabel}<br>
      <span style="color:var(--muted)">${r.elapsed}ms</span>
    `;
            }

            function renderResponse(
                status,
                data,
                cacheHit,
                elapsed,
                key,
                label,
            ) {
                const area = document.getElementById("response-area");

                // Clear placeholder on first response
                if (area.querySelector(".response-placeholder"))
                    area.innerHTML = "";

                const statusClass =
                    {
                        201: "badge-201",
                        400: "badge-400",
                        409: "badge-409",
                    }[status] || "badge-400";

                const block = document.createElement("div");
                block.className = "response-block";

                block.innerHTML = `
      ${label ? `<div class="response-label">${label}</div>` : ""}
      <div class="response-meta">
        <span class="badge ${statusClass}">${status || "ERR"}</span>
        ${cacheHit ? '<span class="badge badge-hit">X-Cache-Hit: true</span>' : ""}
        <span class="badge badge-time">${elapsed}ms</span>
        <span style="color:var(--muted);font-size:0.65rem;">${truncKey(key)}</span>
      </div>
      <div class="response-json">${syntaxHighlight(JSON.stringify(data, null, 2))}</div>
    `;

                area.prepend(block);

                if (area.children.length > 1) {
                    const div = document.createElement("div");
                    div.className = "divider";
                    area.insertBefore(div, area.children[1]);
                }
            }

            function clearResponses() {
                document.getElementById("response-area").innerHTML =
                    '<div class="response-placeholder">← Send a request to see the response here.</div>';
            }

            function addHistory(key, status, cacheHit, elapsed) {
                history.unshift({
                    key,
                    status,
                    cacheHit,
                    elapsed,
                    time: new Date(),
                });
                if (history.length > 20) history.pop();
                renderHistory();
            }

            function renderHistory() {
                const area = document.getElementById("history-area");
                if (!history.length) {
                    area.innerHTML =
                        '<div style="color:var(--muted);font-family:var(--mono);font-size:0.8rem;">No requests yet.</div>';
                    return;
                }

                area.innerHTML = history
                    .map((h) => {
                        const statusColor =
                            h.status === 201
                                ? "var(--accent)"
                                : h.status === 409
                                  ? "var(--danger)"
                                  : "var(--warn)";
                        const cacheIcon = h.cacheHit
                            ? '<span style="color:var(--info)">⎘</span>'
                            : "";
                        return `
        <div class="history-row">
          <span style="color:${statusColor};font-weight:600;">${h.status || "ERR"}</span>
          ${cacheIcon}
          <span class="history-key">${h.key}</span>
          <span style="color:var(--muted)">${h.elapsed}ms</span>
          <span style="color:var(--muted);font-size:0.65rem;">${h.time.toLocaleTimeString()}</span>
        </div>
      `;
                    })
                    .join("");
            }

            function clearHistory() {
                history = [];
                renderHistory();
            }

            function truncKey(k) {
                return k && k.length > 20
                    ? k.slice(0, 8) + "…" + k.slice(-4)
                    : k;
            }

            function syntaxHighlight(json) {
                return json
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(
                        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                        (match) => {
                            if (/^"/.test(match)) {
                                if (/:$/.test(match))
                                    return `<span class="key">${match}</span>`;
                                return `<span class="str">${match}</span>`;
                            }
                            if (/true|false/.test(match))
                                return `<span class="bool">${match}</span>`;
                            if (/null/.test(match))
                                return `<span class="bool">${match}</span>`;
                            return `<span class="num">${match}</span>`;
                        },
                    );
            }

            generateKey();
            setScenario("happy", document.querySelector(".scenario-btn"));
            checkServer();
            setInterval(checkServer, 10000);
        </script>
    </body>
</html>
